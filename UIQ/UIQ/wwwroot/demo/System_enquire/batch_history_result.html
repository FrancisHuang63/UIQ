<?php
require_once("../phaselog_query_function.php");

$sql = $_POST['p_keyw'];
$trg = $_POST['p_batch'];

$str = "SELECT $sql;";
$result = get_history($str);
$headers = get_header($trg);
if(! preg_match("/$trg/", $str) ){
	print "You can only choose the tables in 'Table/View name' menu.\n";
	exit;
}

# Secret SQL query function
if($sql && ! $trg){
	$words = explode(" ", $sql);
	for($i = 0; $i < count($words); $i++){
		if(strcasecmp($words[$i], "from") == 0){
			$trg = $words[$i + 1];
			$headers = get_header($trg);
			break;
		}
	}
}

# In case select_expr is not "*"
if(! preg_match('/^\s*\*/', $sql)){
	$pos = stripos($sql, "from");
	$cols = substr($sql, 0, $pos);
	$headers = explode(",", $cols);
}

echo "<pre>";
echo "<table border=1 cellspacing=0><tr>";

# Generate header
$len = count($headers);
foreach($headers as $i){
	print "<th bgcolor='#CCCCCC'>";
	$parts = explode("_", $i);
	$disp = "";
	foreach($parts as $part){
		$disp .= "$part<br>_";
	}
	$disp = preg_replace('/_$/', "", $disp);
	print "$disp";
}
print "</tr><tr>";

# Display values
foreach($result as $i){
	$cnt++;
	if(! $i){ $i = "-"; }
	print "<td>$i";
	if($cnt % $len == 0){ print "</tr><tr>"; }
}
echo "</tr>";
echo "</pre>";

